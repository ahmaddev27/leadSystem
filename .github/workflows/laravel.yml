name: üöÄ Laravel cPanel Deployment (Stable)

on:
  push:
    branches: [ master ]
    paths-ignore: [ 'README.md', '.gitignore' ]

jobs:
  deploy:
    name: üéØ Deploy Application
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'deploy')

    steps:
      # 1. Checkout code
      - name: üõ†Ô∏è Checkout repository
        uses: actions/checkout@v3

      # 2. Setup PHP
      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, ctype, fileinfo, openssl, pdo, tokenizer, xml
          coverage: none

      # 3. Install dependencies
      - name: üì¶ Install Composer dependencies
        run: |
          composer install --no-interaction --no-dev --prefer-dist --optimize-autoloader --no-scripts
          composer dump-autoload --optimize --no-scripts

      # 4. Environment setup



      # 5. Build assets (if package.json exists)
      - name: üõ†Ô∏è Check for frontend assets
        id: check_assets
        run: |
          if [ -f package-lock.json ]; then
            echo "has_assets=true" >> $GITHUB_OUTPUT
          else
            echo "has_assets=false" >> $GITHUB_OUTPUT
          fi

      - name: üèóÔ∏è Build assets
        if: steps.check_assets.outputs.has_assets == 'true'
        run: |
          npm ci --silent
          npm run build --silent

      # 6. FTP Deployment (Stable Configuration)
      - name: üöÄ Deploy to cPanel
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || '21' }}
          protocol: ${{ secrets.FTP_PROTOCOL || 'ftp' }}
          local-dir: ./
          server-dir: ${{ secrets.FTP_REMOTE_DIR || '/' }}
          exclude: |
            .git/*
            .github/*
            node_modules/*
            tests/*
            *.md
            .env
            .gitignore
            composer.*
            package*.json
            vite.config.js
          log-level: verbose
          dangerous-clean-slate: false
          security: loose  # Corrected from 'passive' to 'loose' or 'strict'
