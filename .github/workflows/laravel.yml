name: ğŸš€ Deploy Laravel to cPanel (Optimized)

on:
  push:
    branches: [ master ]
    paths-ignore: [ 'README.md', '.gitignore' ]

jobs:
  deploy:
    name: ğŸ¯ Deploy Application
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'deploy')

    steps:
      # 1. Checkout code
      - name: ğŸ› ï¸ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. Setup PHP
      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, ctype, fileinfo, openssl, pdo, tokenizer, xml
          coverage: none

      # 3. Composer cache
      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.composer/cache
            vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      # 4. Install dependencies (without scripts)
      - name: âš™ï¸ Install Composer dependencies
        run: |
          composer install --no-interaction --no-dev --prefer-dist --optimize-autoloader --no-scripts
          composer dump-autoload --optimize --no-scripts

      # 5. Environment setup
      - name: ğŸŒ± Prepare environment
        run: |
          cp .env.example .env
          php artisan key:generate --no-interaction --force
          php artisan storage:link

      # 6. Build assets (if using Laravel Mix/Vite)
      - name: ğŸ› ï¸ Build assets (optional)
        run: |
          npm ci --silent
          npm run build --silent
        if: exists('package-lock.json')

      # 7. FTP Deployment
      - name: ğŸš€ Deploy to cPanel
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || '21' }}
          protocol: ${{ secrets.FTP_PROTOCOL || 'ftp' }}
          local-dir: ./
          server-dir: ${{ secrets.FTP_REMOTE_DIR || '/' }}
          exclude: |
            .git/*
            .github/*
            node_modules/*
            tests/*
            *.md
            .env
            .gitignore
            composer.*
            package*.json
            vite.config.js
          dangerous-clean-slate: false
