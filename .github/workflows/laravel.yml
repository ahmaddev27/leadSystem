name: üöÄ Deploy Laravel to cPanel (Optimized)

on:
  push:
    branches: [ master ]
    paths-ignore: [ 'README.md', '.gitignore' ]

jobs:
  deploy:
    name: üéØ Deploy Application
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'deploy')

    steps:
      # 1. Checkout code
      - name: üõ†Ô∏è Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. Setup PHP
      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, ctype, fileinfo, openssl, pdo, tokenizer, xml
          coverage: none

      # 3. Composer cache
      - name: üì¶ Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.composer/cache
            vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      # 4. Install dependencies (without scripts)
      - name: ‚öôÔ∏è Install Composer dependencies
        run: |
          composer install --no-interaction --no-dev --prefer-dist --optimize-autoloader --no-scripts
          composer dump-autoload --optimize --no-scripts


      # 6. Build assets (if using Laravel Mix/Vite)
      - name: üõ†Ô∏è Build assets (if package-lock exists)
        id: check_package
        run: |
          if [ -f package-lock.json ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: üèóÔ∏è Run npm build
        if: steps.check_package.outputs.exists == 'true'
        run: |
          npm ci --silent
          npm run build --silent

      # 7. FTP Deployment
      - name: üöÄ Deploy to cPanel (FTP)
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || '21' }}
          protocol: ${{ secrets.FTP_PROTOCOL || 'ftp' }}
          local-dir: ./
          server-dir: ${{ secrets.FTP_REMOTE_DIR || '/' }}
          exclude: |
            .git/*
            .github/*
            node_modules/*
            tests/*
            *.md
            .env
            .gitignore
            composer.*
            package*.json
            vite.config.js
          # Connection stability improvements:
          retry-count: 3
          retry-wait-time: 5000
          timeout: 300000
          # Transfer optimizations:
          log-level: verbose
          dangerous-clean-slate: false
          security: passive
