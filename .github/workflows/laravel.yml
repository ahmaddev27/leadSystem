name: üöÄ Laravel cPanel Deployment (Stable)

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'
      - '.gitignore'
      - '.env.example'

jobs:
  deploy:
    name: üõ°Ô∏è Stable Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Prevent hanging on connection issues

    steps:
      # 1. Checkout code
      - name: üõ†Ô∏è Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Setup PHP environment
      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, ctype, fileinfo, openssl, pdo, tokenizer, xml
          ini-values: memory_limit=512M, max_execution_time=300
          coverage: none

      # 3. Install dependencies (optimized for production)
      - name: üì¶ Composer Install
        run: |
          composer validate
          composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader --no-scripts
          composer dump-autoload --optimize --no-scripts

      # 4. Environment setup
#      - name: üå± Laravel Setup
#        run: |
#          [ -f .env ] || cp .env.example .env
#          php artisan key:generate --force --no-interaction
#          php artisan storage:link || true

      # 5. Frontend assets (conditional)
      - name: üõ†Ô∏è Check for Frontend
        id: check_frontend
        run: |
          if [ -f package-lock.json ]; then
            echo "has_frontend=true" >> $GITHUB_OUTPUT
          else
            echo "has_frontend=false" >> $GITHUB_OUTPUT
          fi

      - name: üèóÔ∏è Build Assets
        if: steps.check_frontend.outputs.has_frontend == 'true'
        run: |
          npm ci --silent
          npm run build --silent

      # 6. Deployment (with FTPS and retry logic)
      - name: üöÄ Deploy to Server
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || '21' }}
          protocol: ftps  # More reliable than FTP
          security: strict  # FTPS explicit mode
          local-dir: ./
          server-dir: ${{ secrets.FTP_REMOTE_DIR || '/' }}
          log-level: verbose
          dangerous-clean-slate: false
          exclude: |
            .git/
            .github/
            .idea/
            node_modules/
            tests/
            *.md
            *.sqlite
            *.log
            .env*
            docker-compose*
            vite.config.js
            package*.json
            composer.*
            phpunit.xml

      # 7. Post-deployment verification
      - name: ‚úÖ Verify Deployment
        run: |
          echo "Deployment completed successfully at $(date)"
          echo "Triggered by: $GITHUB_SHA"
